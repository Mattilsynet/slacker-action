name: Slack notify

on:
  workflow_dispatch: {}
  push:
    branches:
      - 'main'

jobs:
  post:
    name: notify slack
    runs-on: ubuntu-latest
    outputs:
      slack-message: ${{ steps.slack.outputs.message-id }}
    steps:
      - uses: actions/checkout@v4

      - name: Takes only the repository name and capitalizes it
        id: repo
        run: echo "repo=$(echo ${{ github.repository }} | cut -d / -f 2 | sed 's/^\(.\)/\U\1/')" >> $GITHUB_OUTPUT

      - id: slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        uses: Mattilsynet/slacker-action@main
        with:
          channel-id: C08C995BUAZ
          args: |
            repo=${{ steps.repo.outputs.repo }}
            wf-url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            vest=:safety_vest:
          text: '[vest] [repo] kj√∏rer testene... [vest] <[wf-url] | ${{ github.workflow }}>'
          debug: true

  update:
    name: update slack message
    runs-on: ubuntu-latest
    needs: [post]
    steps:
      - uses: actions/checkout@v4
      
      - name: Takes only the repository name and capitalizes it
        id: repo
        run: echo "repo=$(echo ${{ github.repository }} | cut -d / -f 2 | sed 's/^\(.\)/\U\1/')" >> $GITHUB_OUTPUT
        
      - name: Wait before updating slack message
        run: sleep 8
        
      - id: slack_update
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        uses: Mattilsynet/slacker-action@main
        with:
          channel-id: C08C995BUAZ
          message-id: ${{ needs.post.outputs.slack-message }}
          args: |
            repo=${{ steps.repo.outputs.repo }}
            wf-url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            check=:white_check_mark:
          text: '[check] [repo] Den er i boks! [check] <[wf-url] | ${{ github.workflow }}>'
          debug: true
