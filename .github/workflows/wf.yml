name: Slack notify

on:
  workflow_dispatch: {}
  push:
    branches:
      - 'main'

jobs:
  post:
    name: notify slack
    runs-on: ubuntu-latest
    outputs:
      slack-message: ${{ steps.slack.outputs.message-id }}
    steps:
      - uses: actions/checkout@v4

      - id: repo
        run: echo "repo=$(cut -d / -f 2 <<< ${{ github.repository }})" >> $GITHUB_OUTPUT

      - id: slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        uses: Mattilsynet/slacker-action@main
        with:
          channel-id: C08C995BUAZ
          args: |
            repo=${{ steps.repo.outputs.repo }}
            wf-url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            vest=:safety_vest:
          text: '[vest] __<[wf-url] | [repo]>__ kj√∏rer testene... [vest]'
          debug: true

  update:
    name: update slack message
    runs-on: ubuntu-latest
    needs: [post]
    steps:
      - uses: actions/checkout@v4
      
      - id: repo
        run: echo "repo=$(cut -d / -f 2 <<< ${{ github.repository }})" >> $GITHUB_OUTPUT
        
      - name: Wait before updating slack message
        run: sleep 15
        
      - id: slack_update
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        uses: Mattilsynet/slacker-action@main
        with:
          channel-id: C08C995BUAZ
          message-id: ${{ needs.post.outputs.slack-message }}
          args: |
            repo=${{ steps.repo.outputs.repo }}
            wf-url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            check=:white_check_mark:
          text: '[check] __<[wf-url] | [repo]>__ Den er i boks! [check]'
          debug: true
